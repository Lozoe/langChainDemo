<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>门票助手系统 - 代码逻辑流程图</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #ffffff;
            color: #333333;
        }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            font-size: 24px;
        }

        .mermaid {
            text-align: center;
            margin: 30px 0;
        }

        h2 {
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        ul {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }

        li {
            margin: 8px 0;
            line-height: 1.5;
        }
    </style>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'forest',  // 更清晰的主题
            themeVariables: {
                primaryColor: '#4ECDC4',
                primaryTextColor: '#2C3E50',
                primaryBorderColor: '#2C3E50',
                lineColor: '#2C3E50'
            },
            flowchart: {
                useMaxWidth: true,
                curve: 'basis',
                nodeSpacing: 50,
                rankSpacing: 100
            },
            securityLevel: 'loose'
        });
    </script>
</head>

<body>
    <div class="container">
        <h1>门票助手系统 (assistant_ticket_bot-1.py) - 代码逻辑流程图</h1>
        <div class="mermaid">
            graph TD
            A[程序入口: __main__] --> B[启动GUI模式 app_gui]
            B --> C[初始化助手服务 init_agent_service]
            C --> D[配置LLM参数<br />模型: qwen-turbo-latest<br />超时: 30s<br />重试: 3次]
            D --> E[创建Assistant实例<br />系统提示<br />工具函数定义]
            E --> F[注册SQL执行工具<br />exc_sql]
            F --> G[启动WebUI<br />配置聊天建议]

            C -.-> H[System Prompt定义<br />门票订单表结构<br />SQL查询能力]
            C -.-> I[函数描述<br />exc_sql工具描述]
            F -.-> J[ExcSQLTool类<br />SQL执行逻辑<br />数据库连接]

            G --> K[用户访问Web界面]
            K --> L[输入查询问题]
            L --> M[助手解析问题<br />生成SQL查询]
            M --> N{需要执行SQL?}
            N -->|是| O[调用exc_sql工具]
            N -->|否| P[直接回答]
            O --> Q[连接数据库<br />执行SQL查询]
            Q --> R[返回查询结果<br />格式化为Markdown]
            R --> S[生成最终回答]
            P --> S
            S --> T[在界面显示回答]

            J --> U[数据库连接参数<br />RDS实例<br />MySQL8.0]
            U --> V[执行SQL语句<br />限制返回前10行]
            V --> W[异常处理<br />错误信息返回]

            style A fill:#AED6F1
            style B fill:#85C1E9
            style C fill:#5DADE2
            style D fill:#3498DB
            style E fill:#2980B9
            style F fill:#2874A6
            style G fill:#85C1E9
            style K fill:#ABEBC6
            style L fill:#58D68D
            style M fill:#52BE80
            style N fill:#F9E79F
            style O fill:#F4D03F
            style P fill:#85C1E9
            style Q fill:#F8C471
            style R fill:#82E0AA
            style S fill:#BB8FCE
            style T fill:#F9EBEA
            style U fill:#D5DBDB
            style V fill:#CACFD2
            style W fill:#F1948A
        </div>

        <h2>代码逻辑说明</h2>
        <ul>
            <li><strong>系统初始化</strong>: 配置DashScope API密钥和大语言模型(LLM)参数</li>
            <li><strong>数据模型</strong>: 定义门票订单表结构（tkt_orders），包含订单时间、用户信息、商品详情等字段</li>
            <li><strong>工具函数</strong>: 实现exc_sql工具用于数据库查询，支持执行SQL语句并返回结果</li>
            <li><strong>助手服务</strong>: 创建Assistant实例，具备根据自然语言问题生成SQL查询的功能</li>
            <li><strong>交互界面</strong>: 提供Web GUI界面，预设典型查询问题，便于用户使用</li>
        </ul>
        <p>系统能够回答关于门票销售的各种问题，通过AI生成SQL查询并执行，返回格式化的结果，使非技术人员也能轻松进行数据分析。</p>
    </div>
</body>

</html>